import e from'path';import {log,debug}from'./logger.js';import {writeCompiledTemplate,copyTemplateStructure}from'./templateGenerator.js';import {getAxpertStructure}from'./database.js';import {toClassName}from'./typeMapping.js';import {dirExists,createDir}from'./fileUtils.js';async function R(o,g,s){const t=await getAxpertStructure(o);if(!t)throw new Error(`Axpert structure not found for tstruct: ${o}`);return t}function f(o){return o.charAt(0).toUpperCase()+o.slice(1)}function O(o){return {__module__:o.moduleName,__Module__:f(o.moduleName),__MODULE__:o.moduleName.toUpperCase(),__page__:o.page?.name??"",__Page__:f(o.page?.name??""),__PAGE__:(o.page?.name??"").toUpperCase(),__TSTRUCT__:o.tstruct,__Tstruct__:f(o.tstruct),__tstruct__:o.tstruct.toLowerCase(),tstuct:o.tstruct,PAGE_NAME:o.page?.name??"",PAGE_TITLE:o.pageTitle??"",MASTER_TABLE:o.tables.master.tableName??""}}async function B(o,g,s,t,i,u){log("Generating backend module...");const _=e.join(g,o),A=e.join(_,"models");dirExists(A)||createDir(A);const{master:a,details:S}=i.tables;debug(`Generating master model for table ${a.tableName}`);const C=e.join(A,`${i.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),C,{TABLE_NAME:a.tableName,CLASS_NAME:toClassName(i.pageTitle),COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,MASTER_TABLE:a.tableName,DETAILS:S,SCHEMA:i,toClassName:toClassName},t),debug(`Master model written to ${C}`);for(const c of S){debug(`Generating detail model for table ${c.tableName}`);const I=e.join(A,`${c.tableName.toLocaleLowerCase()}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),I,{SCHEMA:i,TABLE_NAME:c.tableName,CLASS_NAME:toClassName(c.tableName),COLUMNS:c.columns,PRIMARY_KEYS:c.primaryKeys,MASTER_TABLE:a.tableName,DETAILS:S,toClassName:toClassName},t),debug(`Detail model written to ${I}`);}debug("Generating master model init file");const b=e.join(A,"__init__.py");writeCompiledTemplate(e.join(s,"backend","MODEL_INIT.eta"),b,{TABLE_NAME:a.tableName,CLASS_NAME:toClassName(a.tableName),COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,toClassName:toClassName,MASTER_TABLE:a.tableName,DETAILS:S,SCHEMA:i},t),debug(`Master model init file written to ${b}`),debug("Model generation completed"),debug("Generating Service layer...");const d=e.join(_,"services");dirExists(d)||createDir(d),debug(`service path=${d}`);const N=e.join(d,`${i.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_service.py`);writeCompiledTemplate(e.join(s,"backend","MODEL_SERVICE.eta"),N,{SCHEMA:i,MASTER_TABLE:a.tableName,SERVICE_NAME:`${toClassName(a.tableName)}Service`,CLASS_NAME:toClassName(i.pageTitle),DETAILS:S,toClassName:toClassName},t),debug("Generating Data Service layer...");const L=e.join(d,`${i.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_data_service.py`);console.log(JSON.stringify(i),null,2),writeCompiledTemplate(e.join(s,"backend","DATA_SERVICE.eta"),L,{SCHEMA:i,MASTER_TABLE:a.tableName,SERVICE_NAME:"DataService",CLASS_NAME:"DataService",DETAILS:S,toClassName:toClassName},t),debug("Generating Data Service init layer...");const y=e.join(d,"__init__.py");writeCompiledTemplate(e.join(s,"backend","SERVICE_INIT.eta"),y,{SCHEMA:i,MASTER_TABLE:a.tableName,SERVICE_NAME:`${toClassName(a.tableName)}Service`,CLASS_NAME:toClassName(a.tableName),DETAILS:S,toClassName:toClassName},t),debug("Generating Data Service layer completed"),debug("Generating Schema file...");const l=e.join(_,"schemas");dirExists(l)||createDir(l);const $=e.join(s,"backend","SCHEMA_INIT.eta"),j=e.join(s,"backend","SCHEMA.eta");writeCompiledTemplate($,e.join(l,"__init__.py"),{SCHEMA:i,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(a.tableName),DETAILS:S,COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,toClassName:toClassName},t),writeCompiledTemplate(j,e.join(l,`${i.pageTitle?.replace(/\s+/g,"_").toLowerCase()}_schema.py`),{SCHEMA:i,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(i.pageTitle)+"Schema",DETAILS:S,COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,toClassName:toClassName,is_master:true},t);for(const c of S){console.log(`Generating schema for detail table ${c.tableName}`);const I=e.join(l,`${c.tableName}_schema.py`);writeCompiledTemplate(j,I,{SCHEMA:i,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(`${c.tableName}`)+"Schema",DETAILS:S,COLUMNS:c.columns,PRIMARY_KEYS:c.primaryKeys,toClassName:toClassName,is_master:false},t);}const m=e.join(s,"backend","PARAMETER_SCHEMA.eta");writeCompiledTemplate(m,e.join(l,"parameter.py"),{SCHEMA:i,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(a.tableName),DETAILS:S,FIELDS:i.dcs.flatMap(c=>c.fields),toClassName:toClassName},t),debug("Schema file generation completed"),debug("Generating Router file...");const p=e.join(_,"router.py");writeCompiledTemplate(e.join(s,"backend","ROUTER.eta"),p,{SCHEMA:i,MODULE_NAME:o,CLASS_NAME:toClassName(a.tableName),MODEL_SERVICE_NAME:`${toClassName(o)}Service`,DATA_SERVICE_NAME:"DataService",MASTER_TABLE:a.tableName,DETAILS:S,toClassName:toClassName},t),debug(`Router file written to ${p}`);try{debug("Copying other backend files...");const c=e.join(s,"backend","other");copyTemplateStructure(c,_,t);}catch(c){debug(`Error copying other backend files: ${c.message}`);}const D=e.join(_,"__init__.py");writeCompiledTemplate(e.join(s,"backend","INIT.eta"),D,{SCHEMA:i,toClassName:toClassName},t),debug("Backend generation completed");}async function G(o,g,s,t,i,u){log("Generating frontend module..."),log("Generating frontend...");const _=e.join(g,o),A=e.join(_,"components"),a=e.join(_,"schemas");createDir(a),debug(`frontend path=${_}`),createDir(A),debug(`components path=${A}`);for(const m of i.dcs){const p=e.join(a,`${m.name}Schema.ts`);if(u?.dryRun)debug(`Dry-run: skipping schema write for table ${m.tablename} to ${p}`);else {debug(`Writing schema for table ${m.tablename} to ${p}`),writeCompiledTemplate(e.join(s,"frontend","DC_SCHEMA.eta"),p,{DC_NAME:m.name,FIELDS:m.fields,toClassName:toClassName},t);const D=e.join(A,`${m.name}Component.tsx`);debug(`Writing component for table ${m.tablename} to ${D}`),writeCompiledTemplate(e.join(s,"frontend","DC_COMPONENT.eta"),D,{dc:m,DC_NAME:m.name,COMPONENT_NAME:`${m.name}Component`,SCHEMA:i,...i,toClassName:toClassName},t);}}const S=e.join(a,"allSchemas.ts");debug("Generating all schemas index..."),writeCompiledTemplate(e.join(s,"frontend","ALL_SCHEMA.eta"),S,{DCS:i.dcs,capitalize:f,toClassName:toClassName},t);const C=e.join(a,"index.ts");debug(`Writing schema index to ${C}`),writeCompiledTemplate(e.join(s,"frontend","schemaIndex.eta"),C,{DCS:i.dcs,capitalize:f,toClassName:toClassName},t);const b=e.join(A,"index.ts");debug(`Writing component index to ${b}`),writeCompiledTemplate(e.join(s,"frontend","componentIndex.eta"),b,{DCS:i.dcs,capitalize:f,toClassName:toClassName},t);const d=e.join(_,`${t.__Page__}Page.tsx`);debug(`Writing page to ${d}`),writeCompiledTemplate(e.join(s,"frontend","PAGE_FORM.eta"),d,{...i,...t,toClassName:toClassName},t);const N=e.join(_,`${t.__Page__}Page.tsx`);debug(`Writing page form to ${N}`),writeCompiledTemplate(e.join(s,"frontend","PAGE_INDEX.eta"),N,{...i,...t},t);const L=e.join(_,"types.ts");debug(`Writing types to ${L}`),writeCompiledTemplate(e.join(s,"frontend","TYPES.eta"),L,{...i,...t},t);const y=e.join(_,"api.ts");debug(`Writing API to ${y}`),writeCompiledTemplate(e.join(s,"frontend","API.eta"),y,{...i,...t},t);const l=e.join(s,"frontend","other");debug(`Copying other frontend files from ${l}`),copyTemplateStructure(l,_,t),debug("Writing page styles");const $=e.join(_,"styles.css");writeCompiledTemplate(e.join(s,"frontend","PAGE_STYLES.eta"),$,{...i,...t},t),debug("Writing page index");const j=e.join(_,"index.ts");writeCompiledTemplate(e.join(s,"frontend","PAGE_INDEX_FILE.eta"),j,{...i,...t},t),debug("Frontend generation completed");}async function x(o,g,s,t,i,u,_){if(log("Starting Axpert page generation"),debug(`tstruct=${o}`),debug(`module=${g}`),debug(`templateRoot=${i}`),_?.skipBackend&&_?.skipFrontend)throw new Error("Both backend and frontend are skipped. Nothing to generate.");const A=await R(o);debug(`context keys: ${Object.keys(A).join(", ")}`);const a=O({moduleName:g,tstruct:o,...A});({...A});debug(`placeholders: ${Object.keys(a).join(", ")}`),_?.skipBackend?log("Backend generation skipped"):(log("Generating backend..."),B(g,s,i,a,A,{dryRun:_?.dryRun})),_?.skipFrontend?log("Frontend generation skipped"):G(g,t,i,a,A,{dryRun:_?.dryRun}),log("Axpert page generation completed");}export{O as buildAxpertPlaceholders,B as createAxpertBackendModule,G as createAxpertFrontendModule,x as createAxpertPage};