import e from'path';import {log,debug}from'./logger.js';import {writeCompiledTemplate,copyTemplateStructure}from'./templateGenerator.js';import {extractParams,convertSqlToLowercase,getAxpertStructure}from'./database.js';import {toClassName}from'./typeMapping.js';import {dirExists,createDir}from'./fileUtils.js';async function B(o,p,s){const i=await getAxpertStructure(o);if(!i)throw new Error(`Axpert structure not found for tstruct: ${o}`);return i}function d(o){return o.charAt(0).toUpperCase()+o.slice(1)}function G(o){return {__module__:o.moduleName,__Module__:d(o.moduleName),__MODULE__:o.moduleName.toUpperCase(),__page__:o.page?.name??"",__Page__:d(o.page?.name??""),__PAGE__:(o.page?.name??"").toUpperCase(),__TSTRUCT__:o.tstruct,__Tstruct__:d(o.tstruct),__tstruct__:o.tstruct.toLowerCase(),tstuct:o.tstruct,PAGE_NAME:o.page?.name??"",PAGE_TITLE:o.pageTitle??"",MASTER_TABLE:o.tables.master.tableName??""}}async function h(o,p,s,i,n,j){log("Generating backend module...");const M=n.pageTitle?n.pageTitle.replace(/\s+/g,"_").toLowerCase():o;debug(`backend path=${p}`);const _=e.join(p,M),l=e.join(_,"models");dirExists(l)||createDir(l);const{master:r,details:S}=n.tables;debug(`Generating master model for table ${r.tableName}`);const L=e.join(l,`${n.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),L,{TABLE_NAME:r.tableName,CLASS_NAME:toClassName(n.pageTitle),COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,MASTER_TABLE:r.tableName,DETAILS:S,SCHEMA:n,toClassName:toClassName},i),debug(`Master model written to ${L}`);for(const A of S){debug(`Generating detail model for table ${A.tableName}`);const k=e.join(l,`${A.tableName.toLocaleLowerCase()}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),k,{SCHEMA:n,TABLE_NAME:A.tableName,CLASS_NAME:toClassName(A.tableName),COLUMNS:A.columns,PRIMARY_KEYS:A.primaryKeys,MASTER_TABLE:r.tableName,DETAILS:S,toClassName:toClassName},i),debug(`Detail model written to ${k}`);}debug("Generating master model init file");const b=e.join(l,"__init__.py");writeCompiledTemplate(e.join(s,"backend","MODEL_INIT.eta"),b,{TABLE_NAME:r.tableName,CLASS_NAME:toClassName(r.tableName),COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,toClassName:toClassName,MASTER_TABLE:r.tableName,DETAILS:S,SCHEMA:n},i),debug(`Master model init file written to ${b}`),debug("Model generation completed"),debug("Generating Service layer...");const T=e.join(_,"services");dirExists(T)||createDir(T),debug(`service path=${T}`);const I=e.join(T,`${n.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_service.py`);writeCompiledTemplate(e.join(s,"backend","MODEL_SERVICE.eta"),I,{SCHEMA:n,MASTER_TABLE:r.tableName,SERVICE_NAME:`${toClassName(r.tableName)}Service`,CLASS_NAME:toClassName(n.pageTitle),DETAILS:S,toClassName:toClassName},i),debug("Generating Data Service layer...");const D=e.join(T,`${n.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_data_service.py`);writeCompiledTemplate(e.join(s,"backend","DATA_SERVICE.eta"),D,{SCHEMA:n,MASTER_TABLE:r.tableName,SERVICE_NAME:"DataService",CLASS_NAME:"DataService",DETAILS:S,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),debug("Generating Data Service init layer...");const $=e.join(T,"__init__.py");writeCompiledTemplate(e.join(s,"backend","SERVICE_INIT.eta"),$,{SCHEMA:n,MASTER_TABLE:r.tableName,SERVICE_NAME:`${toClassName(r.tableName)}Service`,CLASS_NAME:toClassName(r.tableName),DETAILS:S,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),debug("Generating Data Service layer completed"),debug("Generating Schema file...");const C=e.join(_,"schemas");dirExists(C)||createDir(C);const P=e.join(s,"backend","SCHEMA_INIT.eta"),g=e.join(s,"backend","SCHEMA.eta");writeCompiledTemplate(P,e.join(C,"__init__.py"),{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(r.tableName),DETAILS:S,COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),writeCompiledTemplate(g,e.join(C,`${n.pageTitle?.replace(/\s+/g,"_").toLowerCase()}_schema.py`),{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(n.pageTitle)+"Schema",DETAILS:S,COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,toClassName:toClassName,is_master:true,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);for(const A of S){console.log(`Generating schema for detail table ${A.tableName}`);const k=e.join(C,`${A.tableName}_schema.py`);writeCompiledTemplate(g,k,{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(`${A.tableName}`)+"Schema",DETAILS:S,COLUMNS:A.columns,PRIMARY_KEYS:A.primaryKeys,toClassName:toClassName,is_master:false,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);}const u=e.join(s,"backend","PARAMETER_SCHEMA.eta");writeCompiledTemplate(u,e.join(C,"parameter.py"),{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(r.tableName),DETAILS:S,FIELDS:n.dcs.flatMap(A=>A.fields),toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),debug("Schema file generation completed"),debug("Generating Router file...");const N=e.join(_,"routes.py");writeCompiledTemplate(e.join(s,"backend","ROUTER.eta"),N,{SCHEMA:n,MODULE_NAME:o,CLASS_NAME:toClassName(r.tableName),MODEL_SERVICE_NAME:`${toClassName(o)}Service`,DATA_SERVICE_NAME:"DataService",MASTER_TABLE:r.tableName,DETAILS:S,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),debug(`Router file written to ${N}`);try{debug("Copying other backend files...");const A=e.join(s,"backend","other");copyTemplateStructure(A,_,i);}catch(A){debug(`Error copying other backend files: ${A.message}`);}const w=e.join(_,"__init__.py");writeCompiledTemplate(e.join(s,"backend","INIT.eta"),w,{SCHEMA:n,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),debug("Backend generation completed");}async function v(o,p,s,i,n,j){log("Generating frontend module..."),log("Generating frontend...");const M=n.pageTitle?n.pageTitle.replace(/\s+/g,"_").toLowerCase():o,_=e.join(p,M),l=e.join(_,"components"),r=e.join(_,"schemas");createDir(r),debug(`frontend path=${_}`),createDir(l),debug(`components path=${l}`);for(const g of n.dcs){const u=e.join(r,`${g.name}_schema.ts`);if(j?.dryRun)debug(`Dry-run: skipping schema write for table ${g.tablename} to ${u}`);else {debug(`Writing schema for table ${g.tablename} to ${u}`),writeCompiledTemplate(e.join(s,"frontend","DC_SCHEMA.eta"),u,{DC_NAME:g.name,FIELDS:g.fields,toClassName:toClassName,capitalize:d,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);const N=e.join(l,`${g.name}_component.tsx`);debug(`Writing component for table ${g.tablename} to ${N}`),writeCompiledTemplate(e.join(s,"frontend","DC_COMPONENT.eta"),N,{dc:g,DC_NAME:g.name,COMPONENT_NAME:`${g.name}_component`,SCHEMA:n,...n,toClassName:toClassName,capitalize:d,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);}}const S=e.join(r,"allSchemas.ts");debug("Generating all schemas index..."),writeCompiledTemplate(e.join(s,"frontend","ALL_SCHEMA.eta"),S,{DCS:n.dcs,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);const L=e.join(r,"index.ts");debug(`Writing schema index to ${L}`),writeCompiledTemplate(e.join(s,"frontend","schemaIndex.eta"),L,{DCS:n.dcs,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);const b=e.join(l,"index.ts");debug(`Writing component index to ${b}`),writeCompiledTemplate(e.join(s,"frontend","componentIndex.eta"),b,{DCS:n.dcs,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);const T=e.join(_,`${i.PAGE_TITLE.replace(/\s+/g,"_").toLowerCase()}_page.tsx`);debug(`Writing page to ${T}`),writeCompiledTemplate(e.join(s,"frontend","PAGE.eta"),T,{...n,...i,toClassName:toClassName,capitalize:d,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);const I=e.join(_,`${i.PAGE_TITLE.replace(/\s+/g,"_").toLowerCase()}_form.tsx`);debug(`Writing page form to ${I}`),writeCompiledTemplate(e.join(s,"frontend","PAGE_FORM.eta"),I,{SCHEMA:n,...n,...i,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);const D=e.join(_,"types.ts");debug(`Writing types to ${D}`),writeCompiledTemplate(e.join(s,"frontend","TYPES.eta"),D,{...n,...i,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);const $=e.join(_,"api_client.ts");debug(`Writing API to ${$}`),writeCompiledTemplate(e.join(s,"frontend","API_CLIENT.eta"),$,{...n,...i,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i);try{debug("Copying other frontend files...");const g=e.join(s,"frontend","other");copyTemplateStructure(g,_,i);}catch(g){debug(`Error copying other frontend files: ${g}`);}debug("Writing page styles");const C=e.join(_,"styles.css");writeCompiledTemplate(e.join(s,"frontend","PAGE_STYLES.eta"),C,{...n,...i,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),debug("Writing page index");const P=e.join(_,"index.ts");writeCompiledTemplate(e.join(s,"frontend","PAGE_INDEX_FILE.eta"),P,{...n,...i,capitalize:d,toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams},i),debug("Frontend generation completed");}async function te(o,p,s,i,n,j,M){if(log("Starting Axpert page generation"),debug(`tstruct=${o}`),debug(`module=${p}`),debug(`templateRoot=${n}`),M?.skipBackend&&M?.skipFrontend)throw new Error("Both backend and frontend are skipped. Nothing to generate.");const _=await B(o);debug(`context keys: ${Object.keys(_).join(", ")}`);const l=G({moduleName:p,tstruct:o,..._});({..._});debug(`placeholders: ${Object.keys(l).join(", ")}`),M?.skipBackend?log("Backend generation skipped"):(log("Generating backend..."),h(p,s,n,l,_,{dryRun:M?.dryRun})),M?.skipFrontend?log("Frontend generation skipped"):v(p,i,n,l,_,{dryRun:M?.dryRun}),log("Axpert page generation completed");}export{G as buildAxpertPlaceholders,h as createAxpertBackendModule,v as createAxpertFrontendModule,te as createAxpertPage};