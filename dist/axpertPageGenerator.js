import e from'path';import {log,debug}from'./logger.js';import {writeCompiledTemplate,copyTemplateStructure}from'./templateGenerator.js';import {getAxpertStructure}from'./database.js';import {toClassName}from'./typeMapping.js';import {dirExists,createDir}from'./fileUtils.js';async function O(o,l,s){const i=await getAxpertStructure(o);if(!i)throw new Error(`Axpert structure not found for tstruct: ${o}`);return i}function S(o){return o.charAt(0).toUpperCase()+o.slice(1)}function w(o){return {__module__:o.moduleName,__Module__:S(o.moduleName),__MODULE__:o.moduleName.toUpperCase(),__page__:o.page?.name??"",__Page__:S(o.page?.name??""),__PAGE__:(o.page?.name??"").toUpperCase(),__TSTRUCT__:o.tstruct,__Tstruct__:S(o.tstruct),__tstruct__:o.tstruct.toLowerCase(),tstuct:o.tstruct,PAGE_NAME:o.page?.name??"",PAGE_TITLE:o.pageTitle??"",MASTER_TABLE:o.tables.master.tableName??""}}async function B(o,l,s,i,n,N){log("Generating backend module...");const d=n.pageTitle?n.pageTitle.replace(/\s+/g,"_").toLowerCase():o;debug(`backend path=${l}`);const _=e.join(l,d),g=e.join(_,"models");dirExists(g)||createDir(g);const{master:r,details:m}=n.tables;debug(`Generating master model for table ${r.tableName}`);const C=e.join(g,`${n.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),C,{TABLE_NAME:r.tableName,CLASS_NAME:toClassName(n.pageTitle),COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,MASTER_TABLE:r.tableName,DETAILS:m,SCHEMA:n,toClassName:toClassName},i),debug(`Master model written to ${C}`);for(const c of m){debug(`Generating detail model for table ${c.tableName}`);const D=e.join(g,`${c.tableName.toLocaleLowerCase()}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),D,{SCHEMA:n,TABLE_NAME:c.tableName,CLASS_NAME:toClassName(c.tableName),COLUMNS:c.columns,PRIMARY_KEYS:c.primaryKeys,MASTER_TABLE:r.tableName,DETAILS:m,toClassName:toClassName},i),debug(`Detail model written to ${D}`);}debug("Generating master model init file");const f=e.join(g,"__init__.py");writeCompiledTemplate(e.join(s,"backend","MODEL_INIT.eta"),f,{TABLE_NAME:r.tableName,CLASS_NAME:toClassName(r.tableName),COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,toClassName:toClassName,MASTER_TABLE:r.tableName,DETAILS:m,SCHEMA:n},i),debug(`Master model init file written to ${f}`),debug("Model generation completed"),debug("Generating Service layer...");const p=e.join(_,"services");dirExists(p)||createDir(p),debug(`service path=${p}`);const y=e.join(p,`${n.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_service.py`);writeCompiledTemplate(e.join(s,"backend","MODEL_SERVICE.eta"),y,{SCHEMA:n,MASTER_TABLE:r.tableName,SERVICE_NAME:`${toClassName(r.tableName)}Service`,CLASS_NAME:toClassName(n.pageTitle),DETAILS:m,toClassName:toClassName},i),debug("Generating Data Service layer...");const j=e.join(p,`${n.pageTitle.replace(/\s+/g,"_").toLocaleLowerCase()}_data_service.py`);writeCompiledTemplate(e.join(s,"backend","DATA_SERVICE.eta"),j,{SCHEMA:n,MASTER_TABLE:r.tableName,SERVICE_NAME:"DataService",CLASS_NAME:"DataService",DETAILS:m,toClassName:toClassName},i),debug("Generating Data Service init layer...");const I=e.join(p,"__init__.py");writeCompiledTemplate(e.join(s,"backend","SERVICE_INIT.eta"),I,{SCHEMA:n,MASTER_TABLE:r.tableName,SERVICE_NAME:`${toClassName(r.tableName)}Service`,CLASS_NAME:toClassName(r.tableName),DETAILS:m,toClassName:toClassName},i),debug("Generating Data Service layer completed"),debug("Generating Schema file...");const M=e.join(_,"schemas");dirExists(M)||createDir(M);const $=e.join(s,"backend","SCHEMA_INIT.eta"),A=e.join(s,"backend","SCHEMA.eta");writeCompiledTemplate($,e.join(M,"__init__.py"),{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(r.tableName),DETAILS:m,COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,toClassName:toClassName},i),writeCompiledTemplate(A,e.join(M,`${n.pageTitle?.replace(/\s+/g,"_").toLowerCase()}_schema.py`),{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(n.pageTitle)+"Schema",DETAILS:m,COLUMNS:r.columns,PRIMARY_KEYS:r.primaryKeys,toClassName:toClassName,is_master:true},i);for(const c of m){console.log(`Generating schema for detail table ${c.tableName}`);const D=e.join(M,`${c.tableName}_schema.py`);writeCompiledTemplate(A,D,{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(`${c.tableName}`)+"Schema",DETAILS:m,COLUMNS:c.columns,PRIMARY_KEYS:c.primaryKeys,toClassName:toClassName,is_master:false},i);}const b=e.join(s,"backend","PARAMETER_SCHEMA.eta");writeCompiledTemplate(b,e.join(M,"parameter.py"),{SCHEMA:n,MASTER_TABLE:r.tableName,CLASS_NAME:toClassName(r.tableName),DETAILS:m,FIELDS:n.dcs.flatMap(c=>c.fields),toClassName:toClassName},i),debug("Schema file generation completed"),debug("Generating Router file...");const L=e.join(_,"routes.py");writeCompiledTemplate(e.join(s,"backend","ROUTER.eta"),L,{SCHEMA:n,MODULE_NAME:o,CLASS_NAME:toClassName(r.tableName),MODEL_SERVICE_NAME:`${toClassName(o)}Service`,DATA_SERVICE_NAME:"DataService",MASTER_TABLE:r.tableName,DETAILS:m,toClassName:toClassName},i),debug(`Router file written to ${L}`);try{debug("Copying other backend files...");const c=e.join(s,"backend","other");copyTemplateStructure(c,_,i);}catch(c){debug(`Error copying other backend files: ${c.message}`);}const F=e.join(_,"__init__.py");writeCompiledTemplate(e.join(s,"backend","INIT.eta"),F,{SCHEMA:n,toClassName:toClassName},i),debug("Backend generation completed");}async function G(o,l,s,i,n,N){log("Generating frontend module..."),log("Generating frontend...");const d=n.pageTitle?n.pageTitle.replace(/\s+/g,"_").toLowerCase():o,_=e.join(l,d),g=e.join(_,"components"),r=e.join(_,"schemas");createDir(r),debug(`frontend path=${_}`),createDir(g),debug(`components path=${g}`);for(const A of n.dcs){const b=e.join(r,`${A.name}_schema.ts`);if(N?.dryRun)debug(`Dry-run: skipping schema write for table ${A.tablename} to ${b}`);else {debug(`Writing schema for table ${A.tablename} to ${b}`),writeCompiledTemplate(e.join(s,"frontend","DC_SCHEMA.eta"),b,{DC_NAME:A.name,FIELDS:A.fields,toClassName:toClassName,capitalize:S},i);const L=e.join(g,`${A.name}_component.tsx`);debug(`Writing component for table ${A.tablename} to ${L}`),writeCompiledTemplate(e.join(s,"frontend","DC_COMPONENT.eta"),L,{dc:A,DC_NAME:A.name,COMPONENT_NAME:`${A.name}_component`,SCHEMA:n,...n,toClassName:toClassName,capitalize:S},i);}}const m=e.join(r,"allSchemas.ts");debug("Generating all schemas index..."),writeCompiledTemplate(e.join(s,"frontend","ALL_SCHEMA.eta"),m,{DCS:n.dcs,capitalize:S,toClassName:toClassName},i);const C=e.join(r,"index.ts");debug(`Writing schema index to ${C}`),writeCompiledTemplate(e.join(s,"frontend","schemaIndex.eta"),C,{DCS:n.dcs,capitalize:S,toClassName:toClassName},i);const f=e.join(g,"index.ts");debug(`Writing component index to ${f}`),writeCompiledTemplate(e.join(s,"frontend","componentIndex.eta"),f,{DCS:n.dcs,capitalize:S,toClassName:toClassName},i);const p=e.join(_,`${i.PAGE_TITLE.replace(/\s+/g,"_").toLowerCase()}_page.tsx`);debug(`Writing page to ${p}`),writeCompiledTemplate(e.join(s,"frontend","PAGE.eta"),p,{...n,...i,toClassName:toClassName,capitalize:S},i);const y=e.join(_,`${i.PAGE_TITLE.replace(/\s+/g,"_").toLowerCase()}_form.tsx`);debug(`Writing page form to ${y}`),writeCompiledTemplate(e.join(s,"frontend","PAGE_FORM.eta"),y,{SCHEMA:n,...n,...i,capitalize:S,toClassName:toClassName},i);const j=e.join(_,"types.ts");debug(`Writing types to ${j}`),writeCompiledTemplate(e.join(s,"frontend","TYPES.eta"),j,{...n,...i,capitalize:S,toClassName:toClassName},i);const I=e.join(_,"api_client.ts");debug(`Writing API to ${I}`),writeCompiledTemplate(e.join(s,"frontend","API_CLIENT.eta"),I,{...n,...i,capitalize:S,toClassName:toClassName},i);try{debug("Copying other frontend files...");const A=e.join(s,"frontend","other");copyTemplateStructure(A,_,i);}catch(A){debug(`Error copying other frontend files: ${A}`);}debug("Writing page styles");const M=e.join(_,"styles.css");writeCompiledTemplate(e.join(s,"frontend","PAGE_STYLES.eta"),M,{...n,...i,capitalize:S,toClassName:toClassName},i),debug("Writing page index");const $=e.join(_,"index.ts");writeCompiledTemplate(e.join(s,"frontend","PAGE_INDEX_FILE.eta"),$,{...n,...i,capitalize:S,toClassName:toClassName},i),debug("Frontend generation completed");}async function ee(o,l,s,i,n,N,d){if(log("Starting Axpert page generation"),debug(`tstruct=${o}`),debug(`module=${l}`),debug(`templateRoot=${n}`),d?.skipBackend&&d?.skipFrontend)throw new Error("Both backend and frontend are skipped. Nothing to generate.");const _=await O(o);debug(`context keys: ${Object.keys(_).join(", ")}`);const g=w({moduleName:l,tstruct:o,..._});({..._});debug(`placeholders: ${Object.keys(g).join(", ")}`),d?.skipBackend?log("Backend generation skipped"):(log("Generating backend..."),B(l,s,n,g,_,{dryRun:d?.dryRun})),d?.skipFrontend?log("Frontend generation skipped"):G(l,i,n,g,_,{dryRun:d?.dryRun}),log("Axpert page generation completed");}export{w as buildAxpertPlaceholders,B as createAxpertBackendModule,G as createAxpertFrontendModule,ee as createAxpertPage};