import e from'path';import {log,debug}from'./logger.js';import {writeCompiledTemplate,copyTemplateStructure}from'./templateGenerator.js';import {extractParams,convertSqlToLowercase,getAxpertStructure}from'./database.js';import {toClassName}from'./typeMapping.js';import {dirExists,createDir}from'./fileUtils.js';import {toFileName}from'./utils.js';const A={toClassName:toClassName,convertSqlToLowercase:convertSqlToLowercase,extractParams:extractParams,toFileName:toFileName,capitalize:G};async function W(_,l,s){const t=await getAxpertStructure(_);if(!t)throw new Error(`Axpert structure not found for tstruct: ${_}`);return t}function G(_){return _.charAt(0).toUpperCase()+_.slice(1)}function Y(_){return {__module__:_.moduleName,__Module__:G(_.moduleName),__MODULE__:_.moduleName.toUpperCase(),__page__:_.page?.name??"",__Page__:G(_.page?.name??""),__PAGE__:(_.page?.name??"").toUpperCase(),__TSTRUCT__:_.tstruct,__Tstruct__:G(_.tstruct),__tstruct__:_.tstruct.toLowerCase(),tstuct:_.tstruct,PAGE_NAME:_.page?.name??"",PAGE_TITLE:_.pageTitle??"",MASTER_TABLE:_.tables.master.tableName??""}}async function K(_,l,s,t,n,y){log("Generating backend module...");const f=n.pageTitle?toFileName(n.pageTitle):_;debug(`backend path=${l}`);const o=e.join(l,f),d=e.join(o,"models");dirExists(d)||createDir(d);const{master:a,details:m}=n.tables;debug(`Generating master model for table ${a.tableName}`);const u=e.join(d,`${toFileName(n.pageTitle)}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),u,{TABLE_NAME:a.tableName,CLASS_NAME:toClassName(n.pageTitle),COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,MASTER_TABLE:a.tableName,DETAILS:m,SCHEMA:n,...A},t),debug(`Master model written to ${u}`);for(const S of m){debug(`Generating detail model for table ${S.tableName}`);const r=e.join(d,`${S.tableName.toLocaleLowerCase()}_model.py`);writeCompiledTemplate(e.join(s,"backend","MODEL.eta"),r,{SCHEMA:n,TABLE_NAME:S.tableName,CLASS_NAME:toClassName(S.tableName),COLUMNS:S.columns,PRIMARY_KEYS:S.primaryKeys,MASTER_TABLE:a.tableName,DETAILS:m,...A},t),debug(`Detail model written to ${r}`);}debug("Generating master model init file");const g=e.join(d,"__init__.py");writeCompiledTemplate(e.join(s,"backend","MODEL_INIT.eta"),g,{TABLE_NAME:a.tableName,CLASS_NAME:toClassName(a.tableName),COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,MASTER_TABLE:a.tableName,DETAILS:m,SCHEMA:n,...A},t),debug(`Master model init file written to ${g}`),debug("Model generation completed"),debug("Generating Service layer...");const C=e.join(o,"services");dirExists(C)||createDir(C),debug(`service path=${C}`);const D=e.join(C,`${toFileName(n.pageTitle)}_service.py`);writeCompiledTemplate(e.join(s,"backend","MODEL_SERVICE.eta"),D,{SCHEMA:n,MASTER_TABLE:a.tableName,SERVICE_NAME:`${toClassName(a.tableName)}Service`,CLASS_NAME:toClassName(n.pageTitle),DETAILS:m,...A},t),debug("Generating Data Service layer...");const $=e.join(C,`${toFileName(n.pageTitle)}_data_service.py`);writeCompiledTemplate(e.join(s,"backend","DATA_SERVICE.eta"),$,{SCHEMA:n,MASTER_TABLE:a.tableName,SERVICE_NAME:"DataService",CLASS_NAME:"DataService",DETAILS:m,...A},t),debug("Generating Data Service init layer...");const P=e.join(C,"__init__.py");writeCompiledTemplate(e.join(s,"backend","SERVICE_INIT.eta"),P,{SCHEMA:n,MASTER_TABLE:a.tableName,SERVICE_NAME:`${toClassName(a.tableName)}Service`,CLASS_NAME:toClassName(a.tableName),DETAILS:m,...A},t),debug("Generating Data Service layer completed"),debug("Generating Schema file...");const p=e.join(o,"schemas");dirExists(p)||createDir(p);const F=e.join(s,"backend","SCHEMA_INIT.eta"),L=e.join(s,"backend","SCHEMA.eta");writeCompiledTemplate(F,e.join(p,"__init__.py"),{SCHEMA:n,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(a.tableName),DETAILS:m,COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,...A},t),writeCompiledTemplate(L,e.join(p,`${toFileName(n.pageTitle)}_schema.py`),{SCHEMA:n,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(n.pageTitle)+"Schema",DETAILS:m,COLUMNS:a.columns,PRIMARY_KEYS:a.primaryKeys,...A,is_master:true},t);for(const S of m){console.log(`Generating schema for detail table ${S.tableName}`);const r=e.join(p,`${toFileName(S.tableName)}_schema.py`);writeCompiledTemplate(L,r,{SCHEMA:n,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(`${S.tableName}`)+"Schema",DETAILS:m,COLUMNS:S.columns,PRIMARY_KEYS:S.primaryKeys,...A,is_master:false},t);}const k=e.join(s,"backend","PARAMETER_SCHEMA.eta");writeCompiledTemplate(k,e.join(p,"parameter.py"),{SCHEMA:n,MASTER_TABLE:a.tableName,CLASS_NAME:toClassName(a.tableName),DETAILS:m,FIELDS:n.dcs.flatMap(S=>S.fields),...A},t),debug("Schema file generation completed"),debug("Generating Router file...");const j=e.join(o,"routes.py");writeCompiledTemplate(e.join(s,"backend","ROUTER.eta"),j,{SCHEMA:n,MODULE_NAME:_,CLASS_NAME:toClassName(a.tableName),MODEL_SERVICE_NAME:`${toClassName(_)}Service`,DATA_SERVICE_NAME:"DataService",MASTER_TABLE:a.tableName,DETAILS:m,...A},t),debug(`Router file written to ${j}`);try{debug("Copying other backend files...");const S=e.join(s,"backend","other");copyTemplateStructure(S,o,t);}catch(S){debug(`Error copying other backend files: ${S.message}`);}const H=e.join(o,"__init__.py");writeCompiledTemplate(e.join(s,"backend","INIT.eta"),H,{SCHEMA:n,...A},t),debug("Backend generation completed");}async function V(_,l,s,t,n,y){log("Generating frontend module..."),log("Generating frontend...");const f=n.pageTitle?toFileName(n.pageTitle):_,o=e.join(l,f),d=e.join(o,"components"),a=e.join(o,"schemas"),m=e.join(o,"fill_grids"),u=e.join(o,"subgrids"),g={TEMPLATE_ROOT_PATH:o,IMPORT_API_CLIENT_PATH:e.join(o,"api_client"),IMPORT_COMPONENTS_PATH:e.join(o,"components"),IMPORT_SCHEMAS_PATH:e.join(o,"schemas"),IMPORT_FILL_GRIDS_PATH:e.join(o,"fill_grids"),IMPORT_SUBGRIDS_PATH:e.join(o,"subgrids"),relativePathToRoot:e.relative(o,l)||".",generateImportPath:(r,T="")=>{const B=e.extname(T)!==""?e.dirname(T):T;let I=e.relative(B,r);return I=I.replace(/\\/g,"/").replace(/\.(tsx?|jsx?)$/,""),I.startsWith(".")||(I=`./${I}`),I}};createDir(a),debug(`frontend path=${o}`),createDir(d),debug(`components path=${d}`),createDir(m),debug(`fill grids path=${m}`),createDir(u),debug(`subgrids path=${u}`);for(const r of n.dcs){const T=r.isPopup?e.join(u,"schemas",`${r.name}_schema.ts`):e.join(a,`${r.name}_schema.ts`);if(y?.dryRun)debug(`Dry-run: skipping schema write for table ${r.tablename} to ${T}`);else {debug(`Writing schema for table ${r.tablename} to ${T}`),writeCompiledTemplate(e.join(s,"frontend","DC_SCHEMA.eta"),T,{SCHEMA:n,dc:r,DC_NAME:r.name,FIELDS:r.fields,...A,...g},t);const O=e.join(r.isPopup?u:d,`${r.name}_component.tsx`);debug(`Writing component for table ${r.tablename} to ${O}`),writeCompiledTemplate(e.join(s,"frontend","DC_COMPONENT.eta"),O,{dc:r,DC_NAME:r.name,COMPONENT_NAME:`${r.name}_component`,SCHEMA:n,...n,...A,...g},t);}}const C=e.join(a,"allSchemas.ts");debug("Generating all schemas index..."),writeCompiledTemplate(e.join(s,"frontend","ALL_SCHEMA.eta"),C,{DCS:n.dcs,...A,...g},t);const D=e.join(a,"index.ts");debug(`Writing schema index to ${D}`),writeCompiledTemplate(e.join(s,"frontend","schemaIndex.eta"),D,{SCHEMA:n,DCS:n.dcs,...A,...g},t);const $=e.join(d,"index.ts");debug(`Writing component index to ${$}`),writeCompiledTemplate(e.join(s,"frontend","componentIndex.eta"),$,{SCHEMA:n,DCS:n.dcs.filter(r=>!r.isPopup),...A,...g},t);const P=e.join(u,"index.ts");debug(`Writing subgrid index to ${P}`),writeCompiledTemplate(e.join(s,"frontend","SUBGRID_INDEX.eta"),P,{SCHEMA:n,DCS:n.dcs.filter(r=>r.isPopup),...A,...g},t);const p=e.join(o,`${toFileName(t.PAGE_TITLE)}_page.tsx`);debug(`Writing page to ${p}`),writeCompiledTemplate(e.join(s,"frontend","PAGE.eta"),p,{...n,SCHEMA:n,...t,...A,...g},t);for(const r of n.fillGrids){const T=e.join(m,`${toFileName(r.caption)}_fill_grid.tsx`);debug(`Writing fill grid ${r.name} to ${T}`),writeCompiledTemplate(e.join(s,"frontend","FILL_GRID.eta"),T,{FILL_GRID:r,SCHEMA:n,...n,...t,...A,...g},t);}const F=e.join(m,"index.ts");debug(`Writing fill grids index to ${F}`),writeCompiledTemplate(e.join(s,"frontend","FILL_GRID_INDEX.eta"),F,{SCHEMA:n,FILL_GRIDS:n.fillGrids,...A,...g},t);const L=e.join(o,`${toFileName(t.PAGE_TITLE)}_form.tsx`);debug(`Writing page form to ${L}`),writeCompiledTemplate(e.join(s,"frontend","PAGE_FORM.eta"),L,{SCHEMA:n,...n,...t,...A,...g},t);const k=e.join(o,"types.ts");debug(`Writing types to ${k}`),writeCompiledTemplate(e.join(s,"frontend","TYPES.eta"),k,{...n,...t,...A,...g},t);const j=e.join(o,"api_client.ts");debug(`Writing API to ${j}`),writeCompiledTemplate(e.join(s,"frontend","API_CLIENT.eta"),j,{...n,...t,...A,...g},t);try{debug("Copying other frontend files...");const r=e.join(s,"frontend","other");copyTemplateStructure(r,o,t);}catch(r){debug(`Error copying other frontend files: ${r}`);}debug("Writing page styles");const H=e.join(o,"styles.css");writeCompiledTemplate(e.join(s,"frontend","PAGE_STYLES.eta"),H,{...n,...t,SCHEMA:n,...A,...g},t),debug("Writing page index");const S=e.join(o,"index.ts");writeCompiledTemplate(e.join(s,"frontend","PAGE_INDEX_FILE.eta"),S,{...n,...t,SCHEMA:n,...A,...g},t),writeCompiledTemplate(e.join(s,"frontend","PAGE_MANIFEST.eta"),e.join(o,"page_manifest.tsx"),{...n,...t,SCHEMA:n,...A,...g},t),debug("Frontend generation completed");}async function Ae(_,l,s,t,n,y,f){if(log("Starting Axpert page generation"),debug(`tstruct=${_}`),debug(`module=${l}`),debug(`templateRoot=${n}`),f?.skipBackend&&f?.skipFrontend)throw new Error("Both backend and frontend are skipped. Nothing to generate.");const o=await W(_);debug(`context keys: ${Object.keys(o).join(", ")}`);const d=Y({moduleName:l,tstruct:_,...o});debug(`placeholders: ${Object.keys(d).join(", ")}`),f?.skipBackend?log("Backend generation skipped"):(log("Generating backend..."),K(l,s,n,d,o,{dryRun:f?.dryRun})),f?.skipFrontend?log("Frontend generation skipped"):V(l,t,n,d,o,{dryRun:f?.dryRun}),log("Axpert page generation completed");}export{Y as buildAxpertPlaceholders,K as createAxpertBackendModule,V as createAxpertFrontendModule,Ae as createAxpertPage};