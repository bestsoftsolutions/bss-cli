#!/usr/bin/env node
import {Command}from'commander';import*as m from'path';import {generatePageFromTemplate}from'./templateGenerator.js';import {createAxpertPage}from'./axpertPageGenerator.js';import {getTemplatePath}from'./config.js';import {pickTstructInteractive}from'./axpertPicker.js';import {loadConfig,saveConfig}from'./configLoader.js';import {setLogLevel}from'./logger.js';import {ensurePackage}from'./commands/init.js';import w from'inquirer';const i=new Command;i.command("import-tstruct [tstruct]").description("Create Axpert backend + frontend from DB structure").option("--interactive","Pick tstruct interactively").option("-m, --module <name>","Module name (default: tstruct)").option("-b, --backend <path>","Override backend output path").option("-f, --frontend <path>","Override frontend output path").option("--skip-backend","Skip backend generation").option("--skip-frontend","Skip frontend generation").option("--verbose","Enable verbose output").option("--debug","Enable debug output").option("--dry-run","Preview actions without writing files").action(async(o,t)=>{try{setLogLevel({verbose:t.verbose,debug:t.debug});const e=loadConfig();let n=o;(!n||t.interactive)&&(n=await pickTstructInteractive(e.axpert.db));const a=n.split(",").map(r=>r.trim()).filter(r=>r.length>0);a.length===0&&(console.error("No valid tstruct provided."),process.exit(1)),console.log(`
\u{1F4CB} Starting Axpert page generation for tstruct(s): ${a.length}
`);for(const r of a){console.log(`
\u{1F4CB} Processing tstruct: ${r}
`);const c=t.module??r,d=t.backend??e.paths.backend,p=t.frontend??e.paths.frontend;await createAxpertPage(r,c,d,p,getTemplatePath("axpert"),e.axpert.db,{skipBackend:!!t.skipBackend,skipFrontend:!!t.skipFrontend,dryRun:!!t.dryRun});}console.log(`
\u2705 Axpert pages processed successfully
`);}catch(e){console.error("Error:",e),process.exit(1);}}),i.command("create-page").description("Create a new frontend/backend page from the template structure (no logic, no content)").argument("<module>","Module name (used for placeholder replacement)").argument("<page>","Page name (used for placeholder replacement)").option("-o, --output <path>","Output directory for the new page","./modules").action(async(o,t,e)=>{try{const n=getTemplatePath("page"),a=m.resolve(process.cwd(),e.output,o,t);generatePageFromTemplate(n,a,t),console.log(`
\u2705 Page created at: ${a}
`);}catch(n){console.error("Error creating page:",n),process.exit(1);}}),i.command("init").description("Initialize BSS CLI configuration").action(async()=>{try{console.log("Checking Dependencies..."),await ensurePackage("oracledb",{silent:!0}),console.log("oracledb is installed."),console.log(`All dependencies are satisfied.
`),console.log(`
\u{1F4CB} BSS CLI Initialization
`),console.log(`Please provide the following configuration details:
`);const o=await w.prompt([{type:"input",name:"backendPath",message:"Backend modules path:",default:"./backend/apps/modules",validate:e=>e.trim()!==""||"Required"},{type:"input",name:"frontendPath",message:"Frontend modules path:",default:"./frontend/apps/modules",validate:e=>e.trim()!==""||"Required"},{type:"input",name:"dbUser",message:"Axpert DB user:",validate:e=>e.trim()!==""||"Required"},{type:"password",name:"dbPassword",message:"Axpert DB password:",mask:"*",validate:e=>e.trim()!==""||"Required"},{type:"input",name:"dbConnect",message:"Axpert DB connect string (host:port/service):",validate:e=>e.trim()!==""||"Required"}]),t={paths:{backend:o.backendPath,frontend:o.frontendPath},axpert:{db:{user:o.dbUser,password:o.dbPassword,connectString:o.dbConnect}}};saveConfig(t),console.log(`
\u2705 bss.config.json created successfully
`);}catch(o){console.error("Init failed:",o),process.exit(1);}}),i.command("update").description("Update bss-cli to latest version").action(async()=>{const{selfUpdate:o}=await import('./commands/selfUpdate.js');await o();}),i.parse();