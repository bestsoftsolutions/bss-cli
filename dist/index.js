#!/usr/bin/env node
import {Command}from'commander';import*as g from'fs';import*as c from'path';import {generatePageFromTemplate}from'./templateGenerator.js';import {createAxpertPage}from'./axpertPageGenerator.js';import {getTemplatePath}from'./config.js';import {pickTstructInteractive}from'./axpertPicker.js';import {loadConfig,saveConfig}from'./configLoader.js';import {setLogLevel}from'./logger.js';import {ensurePackage}from'./commands/init.js';import x from'inquirer';import {dirExists}from'./fileUtils.js';const s=new Command;s.command("import-tstruct [tstruct]").description("Create Axpert backend + frontend from DB structure").option("--ts, --tstructs <tstructs>","Comma-separated list of tstructs to process",o=>o.split(",").map(e=>e.trim())).option("--interactive","Pick tstruct interactively").option("-m, --module <name>","Module name (default: tstruct)").option("-g, --group <name>","Group name for frontend menu organization").option("-b, --backend <path>","Override backend output path").option("-f, --frontend <path>","Override frontend output path").option("--skip-backend","Skip backend generation").option("--skip-frontend","Skip frontend generation").option("--verbose","Enable verbose output").option("--debug","Enable debug output").option("--dry-run","Preview actions without writing files").action(async(o,e)=>{try{setLogLevel({verbose:e.verbose,debug:e.debug});const t=loadConfig();let n=o;!n&&e.tstructs&&(n=e.tstructs.join("|")),(!n||e.interactive)&&(n=await pickTstructInteractive(t.axpert.db));const i=n.split("|").map(a=>a.trim()).filter(a=>a.length>0);i.length===0&&(console.error("No valid tstruct provided."),process.exit(1)),console.log(`
\u{1F4CB} Starting Axpert page generation for tstruct(s): ${i.length}
`);for(const a of i){console.log(`
\u{1F4CB} Processing tstruct: ${a}
`);const l=e.module??a,r=e.group??"",u=e.backend??t.paths.backend,d=e.frontend??t.paths.frontend;r&&(console.log(`Module will be placed under group: ${r}`),dirExists(c.join(d,r))===!1&&(console.log(`Creating group directory: ${r}`),e.dryRun||g.mkdirSync(c.join(d,r),{recursive:!0}))),r&&console.log(`Module will be placed under group: ${r}`),await createAxpertPage(a,l,u,c.join(d,r),getTemplatePath("axpert"),t.axpert.db,{skipBackend:!!e.skipBackend,skipFrontend:!!e.skipFrontend,dryRun:!!e.dryRun});}console.log(`
\u2705 Axpert pages processed successfully
`);}catch(t){console.error("Error:",t),process.exit(1);}}),s.command("create-page").description("Create a new frontend/backend page from the template structure (no logic, no content)").argument("<module>","Module name (used for placeholder replacement)").argument("<page>","Page name (used for placeholder replacement)").option("-o, --output <path>","Output directory for the new page","./modules").action(async(o,e,t)=>{try{const n=getTemplatePath("page"),i=c.resolve(process.cwd(),t.output,o,e);generatePageFromTemplate(n,i,e),console.log(`
\u2705 Page created at: ${i}
`);}catch(n){console.error("Error creating page:",n),process.exit(1);}}),s.command("init").description("Initialize BSS CLI configuration").action(async()=>{try{console.log("Checking Dependencies..."),await ensurePackage("oracledb",{silent:!0}),console.log("oracledb is installed."),console.log(`All dependencies are satisfied.
`),console.log(`
\u{1F4CB} BSS CLI Initialization
`),console.log(`Please provide the following configuration details:
`);const o=await x.prompt([{type:"input",name:"backendPath",message:"Backend modules path:",default:"./backend/apps/modules",validate:t=>t.trim()!==""||"Required"},{type:"input",name:"frontendPath",message:"Frontend modules path:",default:"./frontend/apps/modules",validate:t=>t.trim()!==""||"Required"},{type:"input",name:"dbUser",message:"Axpert DB user:",validate:t=>t.trim()!==""||"Required"},{type:"password",name:"dbPassword",message:"Axpert DB password:",mask:"*",validate:t=>t.trim()!==""||"Required"},{type:"input",name:"dbConnect",message:"Axpert DB connect string (host:port/service):",validate:t=>t.trim()!==""||"Required"}]),e={paths:{backend:o.backendPath,frontend:o.frontendPath},axpert:{db:{user:o.dbUser,password:o.dbPassword,connectString:o.dbConnect}}};saveConfig(e),console.log(`
\u2705 bss.config.json created successfully
`);}catch(o){console.error("Init failed:",o),process.exit(1);}}),s.command("update").description("Update bss-cli to latest version").action(async()=>{const{selfUpdate:o}=await import('./commands/selfUpdate.js');await o();}),s.parse();